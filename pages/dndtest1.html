<!DOCTYPE html>
<html>
<head>
    <title>Firebase Authentication Example</title>
    <!-- Include the Firebase JavaScript SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h1 id="inventoryHeader"></h1>

    <div id="login">
        <h2>Login to your Charachter</h2>
        <input type="email" id="email" placeholder="Email" /><br>
        <input type="password" id="password" placeholder="Password" /><br>
        <button onclick="login()">Login</button>
    </div>

    <div id="data" style="display: none;">
        <label for="name">Name:</label>
        <input type="text" id="name" /><br>

        <label for="currentHealth">Current Health:</label>
        <input type="number" id="currentHealth" /><br>

        <label for="maxHealth">Max Health:</label>
        <input type="number" id="maxHealth" /><br>

        <label for="location">Location:</label>
        <input type="text" id="location" /><br>

        <button onclick="saveData()">Save Data</button>
        <button onclick="loadData()">Load Data</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="d20Section">
        <h2>Roll a d20</h2>
        <button onclick="rollD20()">Roll</button>
        <ul id="rollList"></ul>
    </div>

    <script>
        // Initialize Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyCqgWyZOOfVZddqVjV-ZsDpMo6b0F1UJxs",
            authDomain: "joesworldonline-967be.firebaseapp.com",
            databaseURL: "https://joesworldonline-967be-default-rtdb.firebaseio.com",
            projectId: "joesworldonline-967be",
            storageBucket: "joesworldonline-967be.appspot.com",
            messagingSenderId: "817241549916",
            appId: "1:817241549916:web:787af20d01f9172efaca99"
        };
        firebase.initializeApp(firebaseConfig);

        // Declare a global variable to store the user's name
        var userDataName = '';


        // Function to handle d20 roll
        function rollD20() {
            var rollResult = Math.floor(Math.random() * 20) + 1;
            var user = firebase.auth().currentUser;

            if (user) {
                var username = userDataName || user.email; // Use email as a fallback
                var timestamp = new Date().toLocaleString(); // Get current timestamp in a condensed manner
                firebase.database().ref('dnd/d20Rolls').push({
                    username: username,
                    rollResult: rollResult,
                    timestamp: timestamp // Include the timestamp
                }).then(function () {
                    console.log("D20 roll saved successfully");
                }).catch(function (error) {
                    console.log("Error saving D20 roll: " + error.message);
                });
            }
        }



        // Function to listen for d20 roll updates
        function listenForD20Rolls() {
            firebase.database().ref('dnd/d20Rolls').on('child_added', function (snapshot) {
                var rollData = snapshot.val();
                var listItem = document.createElement("li");

                // Display the username, roll result, and timestamp in a condensed manner
                listItem.innerText = new Date(rollData.timestamp).toLocaleString() + " | " + rollData.username + " rolled a " + rollData.rollResult;

                // Create the delete button
                var deleteButton = document.createElement("button");
                deleteButton.innerText = "Delete";
                deleteButton.onclick = function () {
                    deleteRoll(snapshot.key);
                };

                // Append the delete button to the list item
                listItem.appendChild(deleteButton);

                // Append the list item to the rollList
                document.getElementById("rollList").appendChild(listItem);
            });
        }
        // Function to handle login
        function login() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(function (userCredential) {
                    // Successful login
                    console.log("User logged in");
                    // Set the user's display name
                    var user = userCredential.user;
                    var name = document.getElementById("name").value;
                    user.updateProfile({
                        displayName: name
                    }).then(function () {
                        // Display data section and d20 section after setting display name
                        document.getElementById("login").style.display = "none";
                        document.getElementById("data").style.display = "block";
                        document.getElementById("d20Section").style.display = "block";
                        loadData();
                        listenForD20Rolls();
                    }).catch(function (error) {
                        console.log("Error setting user display name: " + error.message);
                    });
                })
                .catch(function (error) {
                    // Error handling
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.log("Error: " + errorMessage);
                });
        }

        // Function to handle logout
        function logout() {
            firebase.auth().signOut().then(function () {
                console.log("User logged out");
                document.getElementById("data").style.display = "none";
                document.getElementById("login").style.display = "block";
            }).catch(function (error) {
                console.log("Error logging out: " + error.message);
            });
        }

        // Function to save data
        function saveData() {
            var name = document.getElementById("name").value;
            var currentHealth = parseInt(document.getElementById("currentHealth").value);
            var maxHealth = parseInt(document.getElementById("maxHealth").value);
            var location = document.getElementById("location").value;

            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    // User is signed in, save data under their UID
                    var uid = user.uid;
                    firebase.database().ref('dnd/users/' + uid).set({
                        name: name,
                        currentHealth: currentHealth,
                        maxHealth: maxHealth,
                        location: location
                    }).then(function () {
                        console.log("Data saved successfully");
                        loadData();
                    }).catch(function (error) {
                        console.log("Error saving data: " + error.message);
                    });
                }
            });
        }

        // Function to load data
        function loadData() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    // User is signed in, load data under their UID
                    var uid = user.uid;
                    firebase.database().ref('dnd/users/' + uid).once('value')
                        .then(function (snapshot) {
                            var data = snapshot.val();
                            document.getElementById("name").value = data.name || '';
                            document.getElementById("currentHealth").value = data.currentHealth || '';
                            document.getElementById("maxHealth").value = data.maxHealth || '';
                            document.getElementById("location").value = data.location || '';
                            // Update the header with the user's name followed by "Inventory"
                            document.getElementById("inventoryHeader").innerText = data.name + "'s Inventory";
                            // Save the user's name to a global variable for later use
                            userDataName = data.name;
                            console.log("Data loaded successfully");
                        })
                        .catch(function (error) {
                            console.log("Error loading data: " + error.message);
                        });
                }
            });
        }

        // Function to delete a roll
        function deleteRoll(rollKey) {
            firebase.database().ref('dnd/d20Rolls/' + rollKey).remove()
                .then(function () {
                    console.log("D20 roll deleted successfully");
                    // Update the roll list after the roll is deleted
                    updateRollList();
                })
                .catch(function (error) {
                    console.log("Error deleting D20 roll: " + error.message);
                });
        }
        // Call the function to listen for d20 roll updates after successful login
        firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
                loadData();
                document.getElementById("login").style.display = "none";
                document.getElementById("data").style.display = "block";
                document.getElementById("d20Section").style.display = "block";
                listenForD20Rolls();
            } else {
                document.getElementById("d20Section").style.display = "none";
            }
        });

        // Function to update the roll list
        function updateRollList() {
            // Clear the existing list
            var rollList = document.getElementById("rollList");
            rollList.innerHTML = "";

            // Re-populate the list with updated data
            firebase.database().ref('dnd/d20Rolls').once('value')
                .then(function (snapshot) {
                    snapshot.forEach(function (childSnapshot) {
                        var rollData = childSnapshot.val();
                        var listItem = document.createElement("li");

                        // Display the username, roll result, and timestamp in a condensed manner
                        listItem.innerText = new Date(rollData.timestamp).toLocaleString() + " | " + rollData.username + " rolled a " + rollData.rollResult;

                        // Create the delete button
                        var deleteButton = document.createElement("button");
                        deleteButton.innerText = "Delete";
                        deleteButton.onclick = function () {
                            deleteRoll(childSnapshot.key);
                        };

                        // Append the delete button to the list item
                        listItem.appendChild(deleteButton);

                        // Append the list item to the rollList
                        rollList.appendChild(listItem);
                    });
                })
                .catch(function (error) {
                    console.log("Error updating roll list: " + error.message);
                });
        }


    </script>
</body>
</html>